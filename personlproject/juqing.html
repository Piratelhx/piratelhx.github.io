import React, { useState, useEffect, useCallback } from 'react';
import { ChevronDown, ChevronRight, FileText, Settings, Users, Palette, Edit3, PlusCircle, Trash2, Save, Copy, Search, Filter, BookOpen, Bot, MessageSquare, GitFork, Eye, ThumbsUp, ThumbsDown, FolderOpen, Home, LayoutDashboard, FilePlus, Brain, Wand2, Zap, Sparkles, Grid, List, ArrowLeft } from 'lucide-react'; // Added ArrowLeft

// Mock data (模拟数据) - Keeping existing mock data
const mockProjects = [
  { id: 'proj1', name: '仙侠奇缘', lastModified: '2024-05-05', status: '进行中', description: '一段跨越千年的爱恨情仇，在修仙世界中展开的史诗冒险。' },
  { id: 'proj2', name: '赛博都市：边缘行者', lastModified: '2024-05-01', status: '规划中', description: '霓虹闪烁的未来都市，一个底层黑客揭露惊天阴谋的故事。' },
  { id: 'proj3', name: '废土求生录', lastModified: '2024-04-20', status: '已归档', description: '文明毁灭之后，幸存者们在残酷的废土世界中挣扎求存。' },
];

const mockNPCs = [
  { id: 'npc1', name: '李逍遥', description: '蜀山弟子，正义凛然', style: '古风, 侠义' },
  { id: 'npc2', name: '夜刃', description: '神秘黑客，亦正亦邪', style: '赛博朋克, 冷酷' },
  { id: 'npc3', name: '老王', description: '废土拾荒者，见多识广', style: '末世, 现实' },
];

const mockStoryNodes = [
  { 
    id: 'chap1', 
    type: 'chapter', 
    title: '第一章：初入江湖', 
    isOpen: true,
    children: [
      { 
        id: 'scene1-1', 
        type: 'scene', 
        title: '场景1.1：村庄奇遇', 
        content: '主角在新手村遇到神秘老人...',
        dialogues: [{npc: '神秘老人', text: '年轻人，我看你骨骼惊奇...'}],
        branches: [] 
      },
      { 
        id: 'scene1-2', 
        type: 'scene', 
        title: '场景1.2：首次试炼', 
        content: '主角接受了第一个任务...',
        dialogues: [],
        branches: [
          {id: 'branch1-2-1', condition: '接受任务', nextNodeId: 'scene1-2-accept'},
          {id: 'branch1-2-2', condition: '拒绝任务', nextNodeId: 'scene1-2-reject'},
        ]
      },
    ] 
  },
  { 
    id: 'chap2', 
    type: 'chapter', 
    title: '第二章：风起云涌', 
    isOpen: false,
    children: [] 
  },
];

const mockStyleTemplates = [
  { id: 'style1', name: '史诗奇幻', description: '宏大叙事，魔法与剑的交织，英雄的史诗旅程。', icon: BookOpen, color: 'bg-purple-500' },
  { id: 'style2', name: '轻松搞笑', description: '幽默风趣的对话，充满欢乐与意外的轻松情节。', icon: Sparkles, color: 'bg-yellow-500' },
  { id: 'style3', name: '悬疑推理', description: '扑朔迷离的案件，层层深入的解谜，挑战你的智慧。', icon: Search, color: 'bg-indigo-500' },
  { id: 'style4', name: '赛博朋克', description: '高科技与低生活的碰撞，霓虹光影下的都市传说。', icon: Zap, color: 'bg-pink-500' },
];

// Helper components (辅助组件)
const Icon = ({ name, className }) => {
  const LucideIcon = name;
  return <LucideIcon className={className || "w-5 h-5"} />;
};

const Button = ({ onClick, children, variant = 'primary', icon, className = '', size = 'md' }) => {
  const baseStyle = "rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-all duration-150 flex items-center justify-center space-x-2 disabled:opacity-50 font-medium";
  const sizeStyles = {
    sm: "px-3 py-1.5 text-sm",
    md: "px-4 py-2 text-base",
    lg: "px-6 py-3 text-lg"
  };
  const variants = {
    primary: "bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500",
    secondary: "bg-gray-200 hover:bg-gray-300 text-gray-800 focus:ring-gray-400",
    danger: "bg-red-500 hover:bg-red-600 text-white focus:ring-red-400",
    ghost: "bg-transparent hover:bg-gray-100 text-gray-700 focus:ring-gray-300",
    outline: "bg-transparent hover:bg-blue-50 border border-blue-500 text-blue-600 focus:ring-blue-300"
  };
  return (
    <button onClick={onClick} className={`${baseStyle} ${sizeStyles[size]} ${variants[variant]} ${className}`}>
      {icon && <Icon name={icon} className="w-4 h-4" />}
      <span>{children}</span>
    </button>
  );
};

const Card = ({ children, className = '', hoverEffect = false }) => {
  return <div className={`bg-white shadow-lg rounded-xl p-6 ${hoverEffect ? 'hover:shadow-xl transition-shadow duration-300' : ''} ${className}`}>{children}</div>;
};

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center p-5 border-b border-gray-200">
          <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
            <Icon name={PlusCircle} className="w-7 h-7 rotate-45" />
          </button>
        </div>
        <div className="p-6">{children}</div>
      </div>
    </div>
  );
};

// Main application component (主应用组件)
function App() {
  const [currentView, setCurrentView] = useState('dashboard'); // dashboard, projectSettings, storyEditor, styleManager
  const [selectedProject, setSelectedProject] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [showNewProjectModal, setShowNewProjectModal] = useState(false);
  const [newProjectName, setNewProjectName] = useState('');
  const [newProjectDescription, setNewProjectDescription] = useState('');


  // Navigation handler (导航处理)
  const navigateTo = (view, project = null) => {
    setCurrentView(view);
    setSelectedProject(project);
  };

  const handleCreateNewProject = () => {
    if (!newProjectName.trim()) {
      alert("项目名称不能为空！"); // Project name cannot be empty!
      return;
    }
    setIsLoading(true);
    // Simulate API call
    setTimeout(() => {
      const newProj = { 
        id: `proj${mockProjects.length + 1}`, 
        name: newProjectName, 
        description: newProjectDescription,
        lastModified: new Date().toISOString().split('T')[0], 
        status: '规划中' 
      };
      mockProjects.unshift(newProj);
      setNewProjectName('');
      setNewProjectDescription('');
      setShowNewProjectModal(false);
      setIsLoading(false);
      navigateTo('projectSettings', newProj); // Navigate to settings of the new project
    }, 1000);
  };

  // Render current view (渲染当前视图)
  const renderView = () => {
    switch (currentView) {
      case 'dashboard':
        return <DashboardPage navigateTo={navigateTo} onNewProject={() => setShowNewProjectModal(true)} />;
      case 'projectSettings':
        return <ProjectSettingsPage project={selectedProject} navigateTo={navigateTo} />;
      case 'storyEditor':
        return <StoryEditorPage project={selectedProject} navigateTo={navigateTo} />;
      case 'styleManager':
        return <StyleManagerPage navigateTo={navigateTo} />;
      default:
        return <DashboardPage navigateTo={navigateTo} onNewProject={() => setShowNewProjectModal(true)} />;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 to-sky-100 font-sans flex flex-col">
      {/* Header (头部导航) */}
      <header className="bg-gray-800/90 text-white shadow-lg sticky top-0 z-40 backdrop-blur-md">
        <div className="container mx-auto px-6 py-4 flex items-center justify-between">
          {/* Updated Timi AI Branding Area */}
          <div className="flex items-center">
            {/* You can replace this span with an actual Timi AI logo image if available */}
            {/* <img src="/path-to-timi-ai-logo.svg" alt="Timi AI" className="h-8" /> */}
            <span className="text-3xl font-extrabold text-sky-400">Timi AI</span>
            <div className="h-6 w-px bg-gray-500 mx-4 self-center"></div> {/* Vertical Separator */}
            <h1 className="text-xl font-semibold text-gray-100">
              游戏剧情<span className="text-blue-400">生成平台</span>
            </h1>
          </div>
          <nav className="space-x-2">
            <Button onClick={() => navigateTo('dashboard')} variant="ghost" className="text-gray-300 hover:text-white hover:bg-gray-700/50">
              <Icon name={LayoutDashboard} className="w-5 h-5 mr-1.5" /> 主控面板
            </Button>
            {selectedProject && (currentView === 'projectSettings' || currentView === 'storyEditor') && ( // Show only if a project is selected and on relevant pages
              <>
                <Button onClick={() => navigateTo('projectSettings', selectedProject)} variant="ghost" className={`text-gray-300 hover:text-white hover:bg-gray-700/50 ${currentView === 'projectSettings' ? 'text-white bg-gray-700/60' : ''}`}>
                  <Icon name={Settings} className="w-5 h-5 mr-1.5" /> 项目设定
                </Button>
                <Button onClick={() => navigateTo('storyEditor', selectedProject)} variant="ghost" className={`text-gray-300 hover:text-white hover:bg-gray-700/50 ${currentView === 'storyEditor' ? 'text-white bg-gray-700/60' : ''}`}>
                  <Icon name={Edit3} className="w-5 h-5 mr-1.5" /> 剧情编辑
                </Button>
              </>
            )}
             {/* Always show Style Manager if no project is selected or on style manager page */}
            {(!selectedProject || currentView === 'styleManager') && (
                 <Button onClick={() => navigateTo('styleManager')} variant="ghost" className={`text-gray-300 hover:text-white hover:bg-gray-700/50 ${currentView === 'styleManager' ? 'text-white bg-gray-700/60' : ''}`}>
                    <Icon name={Palette} className="w-5 h-5 mr-1.5" /> 风格管理
                 </Button>
            )}
          </nav>
        </div>
      </header>

      {/* Main Content (主要内容区域) */}
      <main className="flex-grow container mx-auto px-4 sm:px-6 py-8">
        {renderView()}
      </main>

      {/* Footer (页脚) */}
      <footer className="bg-gray-800/80 text-gray-400 text-center p-5 border-t border-gray-700">
        {/* Updated Copyright with Timi AI */}
        <p>&copy; {new Date().getFullYear()} Timi AI. All rights reserved. Designed with <Icon name={Sparkles} className="inline w-4 h-4 text-yellow-400" /> by AI.</p>
      </footer>

      {/* New Project Modal (新建项目弹窗) */}
      <Modal isOpen={showNewProjectModal} onClose={() => setShowNewProjectModal(false)} title="创建新项目">
        <div className="space-y-6">
          <div>
            <label htmlFor="projectName" className="block text-sm font-medium text-gray-700 mb-1">项目名称 (Project Name)</label>
            <input
              type="text"
              id="projectName"
              value={newProjectName}
              onChange={(e) => setNewProjectName(e.target.value)}
              className="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="例如：我的奇幻大作"
            />
          </div>
          <div>
            <label htmlFor="projectDescription" className="block text-sm font-medium text-gray-700 mb-1">项目简介 (Project Description)</label>
            <textarea
              id="projectDescription"
              value={newProjectDescription}
              onChange={(e) => setNewProjectDescription(e.target.value)}
              rows="3"
              className="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="简要描述您的项目..."
            />
          </div>
          <div className="flex justify-end space-x-3 pt-2">
            <Button onClick={() => setShowNewProjectModal(false)} variant="secondary">取消</Button>
            <Button onClick={handleCreateNewProject} disabled={isLoading} icon={isLoading ? null : FilePlus}>
              {isLoading ? '创建中...' : '创建项目'}
            </Button>
          </div>
        </div>
      </Modal>
    </div>
  );
}

// Dashboard Page (主控面板页面)
const DashboardPage = ({ navigateTo, onNewProject }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
  const filteredProjects = mockProjects.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    (p.description && p.description.toLowerCase().includes(searchTerm.toLowerCase()))
  );

  return (
    <div className="space-y-10">
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
        <h2 className="text-4xl font-bold text-gray-800 tracking-tight">主控面板</h2>
        <Button onClick={onNewProject} icon={FilePlus} size="md">创建新项目</Button>
      </div>

      {/* Search and View Mode Bar (搜索与视图模式条) */}
      <div className="flex flex-col sm:flex-row items-center gap-4 p-4 bg-white rounded-xl shadow-md">
        <div className="relative flex-grow w-full sm:w-auto">
            <Icon name={Search} className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
            <input
              type="text"
              placeholder="搜索项目名称或描述..."
              className="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
        </div>
        <div className="flex items-center space-x-2">
            <span className="text-sm font-medium text-gray-600">视图:</span>
            <Button onClick={() => setViewMode('grid')} variant={viewMode === 'grid' ? 'primary' : 'ghost'} size="sm" icon={Grid} className={viewMode === 'grid' ? '' : 'text-gray-500'} />
            <Button onClick={() => setViewMode('list')} variant={viewMode === 'list' ? 'primary' : 'ghost'} size="sm" icon={List} className={viewMode === 'list' ? '' : 'text-gray-500'} />
        </div>
      </div>
      
      {/* Project List (项目列表) */}
      <section>
        <h3 className="text-2xl font-semibold text-gray-700 mb-6">我的项目</h3>
        {filteredProjects.length > 0 ? (
          <div className={`grid gap-6 ${viewMode === 'grid' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1'}`}>
            {filteredProjects.map(project => (
              <div 
                key={project.id} 
                className={`bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 cursor-pointer group ${viewMode === 'list' ? 'flex items-center p-4' : 'p-0'}`}
                onClick={() => navigateTo('storyEditor', project)}
              >
                {/* Visual Banner for Grid View */}
                {viewMode === 'grid' && (
                    <div className="h-32 bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                        <Icon name={project.name.includes("仙侠") ? Wand2 : project.name.includes("赛博") ? Zap : BookOpen} className="w-12 h-12 text-white opacity-80" />
                    </div>
                )}
                <div className={`p-5 ${viewMode === 'list' ? 'flex-grow' : ''}`}>
                  <div className="flex justify-between items-start mb-2">
                    <h4 className={`font-bold group-hover:text-blue-600 transition-colors ${viewMode === 'grid' ? 'text-xl' : 'text-lg'} text-gray-800`}>{project.name}</h4>
                    <span className={`px-2.5 py-1 text-xs font-semibold rounded-full ${
                      project.status === '进行中' ? 'bg-green-100 text-green-700 ring-1 ring-green-200' : 
                      project.status === '规划中' ? 'bg-yellow-100 text-yellow-700 ring-1 ring-yellow-200' : 
                      'bg-gray-100 text-gray-700 ring-1 ring-gray-200'
                    }`}>{project.status}</span>
                  </div>
                  <p className="text-sm text-gray-600 mb-3 leading-relaxed line-clamp-2">{project.description || "暂无描述"}</p>
                  <p className="text-xs text-gray-400 mb-4">最后修改: {project.lastModified}</p>
                  <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <Button onClick={(e) => { e.stopPropagation(); navigateTo('storyEditor', project);}} variant="primary" size="sm" className="flex-1" icon={Edit3}>
                      编辑剧情
                    </Button>
                    <Button onClick={(e) => { e.stopPropagation(); navigateTo('projectSettings', project); }} variant="outline" size="sm" className="flex-1" icon={Settings}>
                      项目设置
                    </Button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="text-center py-12">
            <Icon name={Search} className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-500 text-xl">没有找到匹配的项目。</p>
            <p className="text-gray-400 mt-2">尝试调整搜索词或创建一个新项目吧！</p>
          </div>
        )}
      </section>

      {/* Quick Actions (快速操作) */}
      <Card className="bg-opacity-80 backdrop-blur-sm">
        <h3 className="text-xl font-semibold text-gray-700 mb-4">快速开始</h3>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <Button onClick={onNewProject} icon={FilePlus} className="w-full justify-center py-3 text-base" variant="primary">创建新剧情项目</Button>
          <Button onClick={() => navigateTo('styleManager')} icon={Palette} className="w-full justify-center py-3 text-base" variant="secondary">管理风格模板</Button>
        </div>
      </Card>
    </div>
  );
};

// Project Settings Page (项目设定页面) 
const ProjectSettingsPage = ({ project, navigateTo }) => {
  if (!project) return <p>请先选择一个项目。</p>; 

  const [worldSetting, setWorldSetting] = useState(project.description || '在这个充满魔法与巨龙的世界...'); 
  const [npcs, setNpcs] = useState(mockNPCs); 
  const [overallStyle, setOverallStyle] = useState('史诗, 奇幻'); 
  const [showAddNpcModal, setShowAddNpcModal] = useState(false);
  const [newNpc, setNewNpc] = useState({ name: '', description: '', style: '' });

  useEffect(() => {
    setWorldSetting(project.description || '在这个充满魔法与巨龙的世界...');
  }, [project]);


  const handleAddNpc = () => {
    if (!newNpc.name.trim()) {
      alert("NPC名称不能为空！");
      return;
    }
    setNpcs([...npcs, { ...newNpc, id: `npc${npcs.length + 1}` }]);
    setNewNpc({ name: '', description: '', style: '' });
    setShowAddNpcModal(false);
  };

  return (
    <div className="space-y-8">
      <div className="flex justify-between items-center mb-2"> {/* Container for title and back button */}
        <h2 className="text-3xl font-semibold text-gray-800">项目设定: <span className="text-blue-600">{project.name}</span></h2>
        <Button onClick={() => navigateTo('dashboard')} variant="outline" icon={ArrowLeft} size="sm">
          返回主控面板
        </Button>
      </div>
      
      <Card>
        <h3 className="text-xl font-semibold text-gray-700 mb-2">世界观设定 (World Bible)</h3>
        <textarea
          value={worldSetting}
          onChange={(e) => setWorldSetting(e.target.value)}
          rows="5"
          className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          placeholder="描述您的游戏世界核心概念、历史背景、地理环境等..."
        />
        <div className="mt-2 text-sm text-gray-500">
          支持Markdown格式。详细的世界观有助于AI生成更贴合的剧情。
        </div>
      </Card>

      <Card>
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-semibold text-gray-700">角色设定 (NPCs)</h3>
          <Button onClick={() => setShowAddNpcModal(true)} icon={PlusCircle}>添加NPC</Button>
        </div>
        <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
          {npcs.map(npc => (
            <div key={npc.id} className="p-3 border rounded-md bg-gray-50 hover:bg-gray-100 transition-colors">
              <h4 className="font-semibold text-gray-800">{npc.name}</h4>
              <p className="text-sm text-gray-600">{npc.description}</p>
              <p className="text-xs text-blue-500">风格: {npc.style}</p>
            </div>
          ))}
        </div>
      </Card>
      
      <Card>
        <h3 className="text-xl font-semibold text-gray-700 mb-2">整体风格定制</h3>
        <input
          type="text"
          value={overallStyle}
          onChange={(e) => setOverallStyle(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          placeholder="例如：黑暗, 成人, 幽默 或选择预设风格模板"
        />
        <div className="mt-2 text-sm text-gray-500">
          定义游戏的整体叙事基调和语言风格。
        </div>
      </Card>

      <Card>
        <h3 className="text-xl font-semibold text-gray-700 mb-2">AI创作规范</h3>
        <textarea
          rows="3"
          className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          placeholder="与美术和策划团队共同制定的AI创作规范，例如对话长度偏好、内容倾向等。"
        />
      </Card>

      <div className="flex justify-end space-x-3 mt-6">
        {/* Removed the redundant "返回主控板" button from here as it's now at the top */}
        <Button onClick={() => alert('项目设定已保存！ (模拟)')} icon={Save}>保存设定</Button>
      </div>

      <Modal isOpen={showAddNpcModal} onClose={() => setShowAddNpcModal(false)} title="添加新NPC">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">NPC名称</label>
            <input type="text" value={newNpc.name} onChange={e => setNewNpc({...newNpc, name: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">描述</label>
            <textarea value={newNpc.description} onChange={e => setNewNpc({...newNpc, description: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" rows="3"></textarea>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">说话风格/标签</label>
            <input type="text" value={newNpc.style} onChange={e => setNewNpc({...newNpc, style: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="例如：古风, 沉稳"/>
          </div>
          <div className="flex justify-end space-x-2">
            <Button onClick={() => setShowAddNpcModal(false)} variant="secondary">取消</Button>
            <Button onClick={handleAddNpc}>添加</Button>
          </div>
        </div>
      </Modal>
    </div>
  );
};


// Story Editor Page (剧情编辑页面)
const StoryEditorPage = ({ project, navigateTo }) => {
  if (!project) return <p>请先选择一个项目进行编辑。</p>;

  const [storyNodes, setStoryNodes] = useState(mockStoryNodes); 
  const [selectedNode, setSelectedNode] = useState(null);
  const [generatedText, setGeneratedText] = useState('');
  const [isLoadingGeneration, setIsLoadingGeneration] = useState(false);
  const [sceneDescription, setSceneDescription] = useState('');
  const [involvedNPCs, setInvolvedNPCs] = useState([]);

  useEffect(() => {
    const currentProjectNodes = mockStoryNodes; 
    setStoryNodes(currentProjectNodes);

    if (currentProjectNodes.length > 0 && currentProjectNodes[0].children.length > 0) {
      const firstScene = currentProjectNodes[0].children[0];
      setSelectedNode(firstScene);
      setSceneDescription(firstScene.content || '');
      setGeneratedText(firstScene.dialogues?.map(d => `${d.npc}: ${d.text}`).join('\n') || '');
    } else {
      setSelectedNode(null);
      setSceneDescription('');
      setGeneratedText('');
    }
    setInvolvedNPCs([]);
  }, [project]); 

  const handleNodeSelect = (node) => {
    setSelectedNode(node);
    setSceneDescription(node.content || '');
    if(node.dialogues && node.dialogues.length > 0){
      setGeneratedText(node.dialogues.map(d => `${d.npc}: ${d.text}`).join('\n'));
    } else {
      setGeneratedText('');
    }
    setInvolvedNPCs([]); 
  };

  const toggleNodeOpen = (nodeId) => {
    setStoryNodes(prevNodes => 
      prevNodes.map(node => {
        if (node.id === nodeId && node.type === 'chapter') {
          return { ...node, isOpen: !node.isOpen };
        }
        return node;
      })
    );
  };

  const handleGenerateText = () => {
    if (!selectedNode) {
      alert("请先选择一个剧情节点！");
      return;
    }
    if (!sceneDescription.trim()) {
      alert("场景描述不能为空！");
      return;
    }
    setIsLoadingGeneration(true);
    setTimeout(() => {
      const npcOptions = mockNPCs.map(npc => npc.name);
      const randomNpc1 = npcOptions[Math.floor(Math.random() * npcOptions.length)] || "NPC A";
      const randomNpc2 = npcOptions[Math.floor(Math.random() * npcOptions.length)] || "NPC B";
      
      let newText = `基于场景 "${sceneDescription}" 和角色 ${involvedNPCs.join(', ') || '未知角色'}：\n`;
      newText += `${randomNpc1}: 这就是你说的那个神秘洞穴吗？看起来平平无奇。\n`;
      newText += `${randomNpc2}: 不要被表象迷惑，真正的危险往往隐藏在最不起眼的地方。\n`;
      if (Math.random() > 0.5) {
        newText += `${randomNpc1}: 我感觉到了强烈的能量波动！\n`;
      }
      if (selectedNode.branches && selectedNode.branches.length > 0) {
        newText += `\n[剧情分支提示：玩家可以选择 ${selectedNode.branches.map(b => `"${b.condition}"`).join(' 或 ')} ]`;
      }
      setGeneratedText(newText);
      setIsLoadingGeneration(false);
    }, 1500);
  };

  const StoryTreeNode = ({ node, onSelect, currentSelectedNodeId, level = 0 }) => {
    const isSelected = currentSelectedNodeId === node.id;
    return (
      <div style={{ paddingLeft: `${level * 20}px` }}>
        <div 
          className={`flex items-center space-x-2 p-2 my-0.5 rounded-md cursor-pointer transition-colors ${isSelected ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'}`}
          onClick={() => onSelect(node)}
        >
          {node.type === 'chapter' && (node.children && node.children.length > 0) && (
            <button onClick={(e) => { e.stopPropagation(); toggleNodeOpen(node.id); }} className="p-0.5 rounded hover:bg-gray-200">
              <Icon name={node.isOpen ? ChevronDown : ChevronRight} className="w-4 h-4 text-gray-500" />
            </button>
          )}
          <Icon name={node.type === 'chapter' ? FolderOpen : FileText} className={`w-5 h-5 ${node.type === 'chapter' ? 'text-yellow-500' : 'text-blue-500'}`} />
          <span className="text-sm">{node.title}</span>
        </div>
        {node.type === 'chapter' && node.isOpen && node.children && (
          <div className="mt-0.5">
            {node.children.map(child => (
              <StoryTreeNode key={child.id} node={child} onSelect={onSelect} currentSelectedNodeId={currentSelectedNodeId} level={level + 1} />
            ))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="space-y-6"> {/* Added space-y for overall page structure */}
        <div className="flex justify-between items-center">
            <h2 className="text-3xl font-semibold text-gray-800">
                剧情编辑: <span className="text-blue-600">{project.name}</span>
            </h2>
            <Button onClick={() => navigateTo('dashboard')} variant="outline" icon={ArrowLeft} size="sm">
                返回主控面板
            </Button>
        </div>
        <div className="flex flex-col md:flex-row gap-6 h-[calc(100vh-280px)]"> {/* Adjusted height calculation */}
          <Card className="w-full md:w-1/3 h-full overflow-y-auto flex flex-col">
            <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-700">剧情结构</h3>
              <Button size="sm" icon={PlusCircle} variant="ghost">新增节点</Button>
            </div>
            <div className="flex-grow overflow-y-auto -mr-2 pr-2"> 
                {storyNodes.map(node => (
                <StoryTreeNode key={node.id} node={node} onSelect={handleNodeSelect} currentSelectedNodeId={selectedNode?.id} />
                ))}
            </div>
          </Card>

          <Card className="w-full md:w-2/3 h-full flex flex-col">
            <h3 className="text-lg font-semibold text-gray-700 mb-4 pb-3 border-b border-gray-200">
              编辑节点: <span className="text-blue-600">{selectedNode ? selectedNode.title : '未选择节点'}</span>
            </h3>
            {selectedNode ? (
              <div className="flex-grow flex flex-col space-y-4 overflow-y-auto pr-2"> 
                <div className="space-y-3 p-1">
                  <div>
                    <label className="block text-sm font-medium text-gray-700">场景描述/目标</label>
                    <textarea
                      value={sceneDescription}
                      onChange={(e) => setSceneDescription(e.target.value)}
                      rows="3"
                      className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                      placeholder="例如：主角与NPC A在酒馆相遇，NPC A试图向主角提供一个危险的任务"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700">参与NPC (可选)</label>
                    <div className="flex flex-wrap gap-2 mt-1">
                      {mockNPCs.slice(0,5).map(npc => ( 
                        <button 
                          key={npc.id}
                          onClick={() => {
                            setInvolvedNPCs(prev => 
                              prev.includes(npc.name) ? prev.filter(n => n !== npc.name) : [...prev, npc.name]
                            )
                          }}
                          className={`px-3 py-1.5 border rounded-full text-sm transition-all ${involvedNPCs.includes(npc.name) ? 'bg-blue-500 text-white ring-2 ring-blue-300' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
                        >
                          {npc.name}
                        </button>
                      ))}
                    </div>
                  </div>
                  <Button onClick={handleGenerateText} icon={Wand2} disabled={isLoadingGeneration} className="w-full py-2.5">
                    {isLoadingGeneration ? '正在生成剧情...' : 'AI生成剧情/对话'}
                  </Button>
                </div>

                <div className="flex-grow flex flex-col border-t pt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">生成结果 (AI Output)</label>
                  <textarea
                    value={generatedText}
                    onChange={(e) => setGeneratedText(e.target.value)}
                    rows="8" 
                    className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 flex-grow resize-y" 
                    placeholder="AI生成的剧情或对话将显示在这里..."
                  />
                  <div className="mt-3 flex items-center justify-between">
                    <div className="flex space-x-2">
                       <Button variant="ghost" size="sm" icon={ThumbsUp} className="text-green-500 hover:bg-green-100 px-2 py-1">满意</Button>
                       <Button variant="ghost" size="sm" icon={ThumbsDown} className="text-red-500 hover:bg-red-100 px-2 py-1">不满意</Button>
                    </div>
                    <div className="flex space-x-2">
                      <Button variant="secondary" size="sm" icon={Copy} className="px-2 py-1">复制</Button>
                      <Button icon={Save} size="sm" className="px-2 py-1">保存到节点</Button>
                    </div>
                  </div>
                </div>
                 {selectedNode.branches && selectedNode.branches.length > 0 && (
                  <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <h4 className="text-sm font-semibold text-yellow-700 flex items-center"><Icon name={GitFork} className="w-4 h-4 mr-1.5" /> 剧情分支点</h4>
                    <ul className="list-disc list-inside text-sm text-yellow-600 mt-1 pl-1">
                      {selectedNode.branches.map(branch => (
                        <li key={branch.id}>玩家选择 "{branch.condition}" 将导向新剧情。</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            ) : (
              <div className="flex-grow flex flex-col items-center justify-center text-center p-4">
                <Icon name={FileText} className="w-16 h-16 text-gray-300 mb-4" />
                <p className="text-gray-500 text-lg">请从左侧选择一个剧情节点进行编辑。</p>
                <p className="text-gray-400 mt-1">或者，在剧情结构中创建一个新节点开始您的创作。</p>
              </div>
            )}
          </Card>
        </div>
    </div>
  );
};


// Style Manager Page (风格管理页面)
const StyleManagerPage = ({ navigateTo }) => {
  const [styles, setStyles] = useState(mockStyleTemplates);
  const [showAddStyleModal, setShowAddStyleModal] = useState(false);
  const [newStyle, setNewStyle] = useState({ name: '', description: '', samples: '', icon: 'Sparkles', color: 'bg-gray-500' }); 

  const availableIcons = [BookOpen, Sparkles, Search, Zap, Palette, Wand2, Bot, MessageSquare]; 
  const availableColors = ['bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 'bg-teal-500'];


  const handleAddStyle = () => {
    if (!newStyle.name.trim()) {
      alert("风格名称不能为空！");
      return;
    }
    setStyles([...styles, { ...newStyle, id: `style${styles.length + 1}` }]);
    setNewStyle({ name: '', description: '', samples: '', icon: 'Sparkles', color: 'bg-gray-500' });
    setShowAddStyleModal(false);
  };

  return (
    <div className="space-y-10">
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
        <h2 className="text-4xl font-bold text-gray-800 tracking-tight">风格模板管理</h2>
        <div className="flex items-center gap-x-4"> {/* Group create and back buttons */}
            <Button onClick={() => setShowAddStyleModal(true)} icon={PlusCircle} size="md">创建新风格</Button>
            <Button onClick={() => navigateTo('dashboard')} variant="outline" icon={ArrowLeft} size="md">
                返回主控面板
            </Button>
        </div>
      </div>

      {styles.length > 0 ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {styles.map(style => (
            <Card key={style.id} className="flex flex-col justify-between group hover:shadow-xl transition-all duration-300 ease-in-out transform hover:-translate-y-1 relative overflow-hidden">
              <div className={`absolute top-0 left-0 w-full h-1.5 ${style.color || 'bg-gray-300'}`}></div>
              <div className="pt-5">
                <div className="flex items-center mb-3">
                  <div className={`p-2.5 rounded-lg mr-3 ${style.color || 'bg-gray-200'} bg-opacity-20`}>
                     <Icon name={style.icon || Sparkles} className={`w-6 h-6 ${style.color ? style.color.replace('bg-', 'text-') : 'text-gray-600'}`} />
                  </div>
                  <h4 className="text-xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors">{style.name}</h4>
                </div>
                <p className="text-sm text-gray-600 mb-4 leading-relaxed line-clamp-3 flex-grow min-h-[60px]">{style.description}</p>
              </div>
              <div className="mt-auto pt-4 border-t border-gray-100 flex space-x-2">
                <Button variant="outline" size="sm" className="text-sm flex-1" icon={Edit3}>编辑</Button>
                <Button 
                    variant="ghost" 
                    size="sm" 
                    className="text-sm flex-1 text-red-500 hover:bg-red-50" 
                    icon={Trash2}
                    onClick={(e) => {
                        e.stopPropagation(); 
                        if(window.confirm(`确定要删除风格 "${style.name}" 吗?`)) {
                            setStyles(styles.filter(s => s.id !== style.id));
                        }
                    }}
                >
                    删除
                </Button>
              </div>
            </Card>
          ))}
        </div>
      ) : (
        <div className="text-center py-12">
            <Icon name={Palette} className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-500 text-xl">暂无风格模板。</p>
            <p className="text-gray-400 mt-2">创建一个新风格，让您的剧情创作更高效！</p>
        </div>
      )}
      
      <Modal isOpen={showAddStyleModal} onClose={() => setShowAddStyleModal(false)} title="创建新风格模板">
        <div className="space-y-5">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">风格名称</label>
            <input type="text" value={newStyle.name} onChange={e => setNewStyle({...newStyle, name: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">描述</label>
            <textarea value={newStyle.description} onChange={e => setNewStyle({...newStyle, description: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">图标选择</label>
            <div className="flex flex-wrap gap-2 mt-1">
                {availableIcons.map(IconComponent => (
                    <button 
                        key={IconComponent.displayName || IconComponent.name}
                        onClick={() => setNewStyle({...newStyle, icon: IconComponent})}
                        className={`p-2 border rounded-md ${newStyle.icon === IconComponent ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                    >
                        <Icon name={IconComponent} className="w-5 h-5" />
                    </button>
                ))}
            </div>
          </div>
           <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">主题颜色</label>
            <div className="flex flex-wrap gap-2 mt-1">
                {availableColors.map(colorClass => (
                    <button 
                        key={colorClass}
                        onClick={() => setNewStyle({...newStyle, color: colorClass})}
                        className={`w-8 h-8 rounded-full border-2 ${newStyle.color === colorClass ? 'ring-2 ring-offset-2 ring-blue-500' : 'border-gray-200'} ${colorClass}`}
                    />
                ))}
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">学习样本 (可选)</label>
            <textarea value={newStyle.samples} onChange={e => setNewStyle({...newStyle, samples: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="提供一些符合该风格的文本样本，供模型学习..."></textarea>
          </div>
          <div className="flex justify-end space-x-3 pt-3">
            <Button onClick={() => setShowAddStyleModal(false)} variant="secondary">取消</Button>
            <Button onClick={handleAddStyle} icon={PlusCircle}>创建风格</Button>
          </div>
        </div>
      </Modal>
    </div>
  );
};

export default App;
